{%- if "mfJMONStreamingFlow" in flow.metaflow_code and "eq" in metaobject.application_code -%}

{%- set meta_domains = ["dMeta"] -%}
{%- set source_domains = ["dSourceKeyColumn", "dSourceColumn"] -%}
{%- set target_domains = ["dSourceKeyColumn", "dSourceColumn", "dSourceMaskedColumn", "dSourceHashedColumn"] -%}

{%- set schema = metaobject.application_code -%}
{%- set table = metaobject.entitytype_pname -%}

{%- set diagram_id = flow.propvalues_json.flow_uuid -%}

{%- set consume_node = namespace(flowtask_uuid=None, task=none) -%}
{%- set consume_sensitive_node = namespace(flowtask_uuid=none, task=none) -%}

{%- set union_sensitivecheck_node = namespace(flowtask_uuid=none, task=none) -%}

{%- set protect_node = namespace(flowtask_uuid=None, task=none, source_attributes=[], target_attributes=[], script_lines=[], processed=[]) -%}

{%- set check_sensitive_rule_node = namespace(flowtask_uuid=none, task=none) -%}

{%- set enrich_cdc_node = namespace(flowtask_uuid=none) -%}
{%- set enrich_rdo_node = namespace(flowtask_uuid=none) -%}

{%- set load_rdo_node = namespace(flowtask_uuid=None, task=none) -%}
{%- set load_cdc_node = namespace(flowtask_uuid=none, task=none) -%}

{%- set source_schema = namespace(id=none) -%}
{%- set mask_schema = namespace(id=none) -%}

{%- set sensitive_consume_union = namespace(uuid=none, flowtask_to=none, flowtask_from=none) -%}
{%- set consume_union = namespace(uuid=none, flowtask_to=none, flowtask_from=none) -%}
{%- set union_protect = namespace(uuid=none, flowtask_to=none, flowtask_from=none) -%}
{%- set protect_filter = namespace(uuid=none, flowtask_to=none, flowtask_from=none) -%}
{%- set filter_enrich_rdo = namespace(uuid=none, flowtask_to=none, flowtask_from=none) -%}
{%- set filter_enrich_cdc = namespace(uuid=none, flowtask_to=none, flowtask_from=none) -%}
{%- set enrich_rdo_load = namespace(uuid=none, flowtask_to=none, flowtask_from=none) -%}
{%- set enrich_cdc_load = namespace(uuid=none, flowtask_to=none, flowtask_from=none) -%}

{%- for task in flow.flowtasks %}
    {%- if task.metaflowtask_code == "mcRDO.mfJMONStreamingFlow.mmConsumeData" -%}
        {%- set consume_node.flowtask_uuid = task.propvalues_json.flowtask_uuid -%}
        {%- set consume_node.task = task %}
    {%- elif task.metaflowtask_code == "mcRDO.mfJMONStreamingFlow.mmConsumeSensitiveFlag" -%}
        {%- set consume_sensitive_node.flowtask_uuid = task.propvalues_json.flowtask_uuid -%}
        {%- set consume_sensitive_node.task = task %}
    {%- elif task.metaflowtask_code == "mcRDO.mfJMONStreamingFlow.mmUnionSensitiveFlagData" -%}
        {%- set union_sensitivecheck_node.flowtask_uuid = task.propvalues_json.flowtask_uuid -%}
        {%- set union_sensitivecheck_node.task = task %}
    {%- elif task.metaflowtask_code == "mcRDO.mfJMONStreamingFlow.mmHideSensitiveData" -%}
        {%- set protect_node.flowtask_uuid = task.propvalues_json.flowtask_uuid -%}
        {%- set protect_node.task = task -%}
    {%- elif task.metaflowtask_code == "mcRDO.mfJMONStreamingFlow.mmCheckSensitiveRules" -%}
        {%- set check_sensitive_rule_node.flowtask_uuid = task.propvalues_json.flowtask_uuid -%}
        {%- set check_sensitive_rule_node.task = task -%}
    {%- elif task.metaflowtask_code == "mcRDO.mfJMONStreamingFlow.mmEnrichTechCols.cdc" -%}
        {%- set enrich_cdc_node.flowtask_uuid = task.propvalues_json.flowtask_uuid -%}
        {%- set enrich_cdc_node.task = task -%}
    {%- elif task.metaflowtask_code == "mcRDO.mfJMONStreamingFlow.mmEnrichTechCols.rdo" -%}
        {%- set enrich_rdo_node.flowtask_uuid = task.propvalues_json.flowtask_uuid -%}
        {%- set enrich_rdo_node.task = task -%}
    {%- elif task.metaflowtask_code == "mcRDO.mfJMONStreamingFlow.mmLoadTargetData.rdo" -%}
        {%- set load_rdo_node.flowtask_uuid = task.propvalues_json.flowtask_uuid -%}
        {%- set load_rdo_node.task = task -%}
    {%- elif task.metaflowtask_code == "mcRDO.mfJMONStreamingFlow.mmLoadTargetData.cdc" -%}
        {%- set load_cdc_node.flowtask_uuid = task.propvalues_json.flowtask_uuid -%}
        {%- set load_cdc_node.task = task -%}
    {%- endif -%}
{%- endfor -%}

{%- for structure in metaobject.structures -%}
    {%- if structure.metastructure_code == "mcRDO.msSourceDefinition" -%}
        {%- set source_schema.id = structure.propvalues_json.structure_uuid -%}
    {%- elif structure.metastructure_code == "mcRDO.msReplicaDataObject" -%}
        {%- set mask_schema.id = structure.propvalues_json.structure_uuid -%}
    {%- endif -%}
{%- endfor -%}


{%- for structure in protect_node.task.flowtask_structures -%}
    {%- for attr in structure.structure.attributes -%}
        {%- if attr.domain_code in source_domains and (not attr.attribute_pname.endswith("_mask") or (not attr.attribute_pname.endswith("_hash"))) -%}
            {%- if attr.attribute_pname not in protect_node.source_attributes -%}
                {%- set _ = protect_node.source_attributes.append(attr.attribute_pname) -%}
            {%- endif -%}
        {%- endif -%}
        {%- if attr.domain_code in target_domains -%}
            {%- if attr.attribute_pname not in protect_node.target_attributes -%}
                {%- set _ = protect_node.target_attributes.append(attr.attribute_pname) -%}
            {%- endif -%}
        {%- endif -%}
    {%- endfor -%}
{%- endfor -%}

{%- set output_structure = namespace(struct=none) -%}
{%- for struct in protect_node.task.flowtask_structures -%}
  {%- if output_structure.struct is none and struct.get('directiontype_code') == 'output' -%}
    {%- set output_structure.struct = struct -%}
  {%- endif -%}
{%- endfor -%}

{%- if output_structure.struct is none -%}
  {%- for struct in protect_node.task.flowtask_structures -%}
    {%- if output_structure.struct is none and struct.get('metaobject') -%}
      {%- set output_structure.struct = struct -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- if output_structure.struct is not none -%}
  {%- set attributes = output_structure.struct.structure.attributes -%}
    {%- for attr in attributes -%}
      {%- if attr_pname not in protect_node.processed -%}
        {%- set attr_name = attr.attribute_name -%}
        {%- set attr_pname = attr.attribute_pname -%}
        {%- set attr_domain = attr.domain_code -%}
        {%- set tool_type = attr.tooldatatype_code -%}
        {%- set base_type = attr.basedatatype_code -%}
        {%- set src_upper = attr_name | upper -%}
        {%- set _ = protect_node.processed.append(attr_pname) -%}

        {%- if not attr_domain.startswith('dMeta') -%}

          {%- if attr_domain in source_domains -%}
            {%- if tool_type == 'timestamp' or 'bdtTimestamp' in base_type -%}
              {%- set line = attr_name ~ ' = LocalDateTime.parse(' ~ src_upper ~ ', DateTimeFormatter.ofPattern(\\"yyyy-MM-dd HH:mm:ss.SSSSSS\\"))' -%}
            {%- else -%}
              {%- set line = attr_name  ~ ' = '  ~ src_upper -%}
            {%- endif -%}
            {%- set _ = protect_node.script_lines.append(line) -%}
          {%- elif attr_domain == 'dSourceMaskedColumn' -%}
            {%- set line = attr_name ~ '_mask = protector.maskData(\'' ~ attr_name ~ '\', ' ~ src_upper ~ ')' -%}
            {%- set _ = protect_node.script_lines.append(line) -%}
          {%- elif attr_domain == 'dSourceHashedColumn' -%}
            {%- set line = attr_name ~ '_hash = (' ~ src_upper ~ ' == null) ? null : (' ~ src_upper ~ '.trim() == \'\') ? null : protector.hashData(\'' ~ attr_name ~ '\', ' ~ src_upper ~ '.trim())' -%}
            {%- set _ = protect_node.script_lines.append(line) -%}
          {%- endif -%}

          {%- if attr_domain in source_domains and not (attr_name.endswith('_mask') or attr_name.endswith('_hash')) -%}
            {%- if attr_name not in protect_node.source_attributes -%}
              {%- set _ = protect_node.source_attributes.append(attr_name) -%}
            {%- endif -%}
          {%- endif -%}

          {%- if attr_domain in target_domains -%}
            {%- if attr_name not in protect_node.target_attributes -%}
              {%- set _ = protect_node.target_attributes.append(attr_name) -%}
            {%- endif -%}
          {%- endif -%}

        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
{%- endif -%}

{%- set protection_script = protect_node.script_lines | join('\\n') -%}

{%- for transition in flow.flowtransitions -%}
    {%- if transition.flowtask_from_code.endswith(".consume_sensitive_flag") and transition.flowtask_to_code.endswith(".union_sensitivecheck") -%}
        {%- set sensitive_consume_union.uuid = transition.propvalues_json.flowtransition_uuid -%}
    {%- endif -%}

    {%- if transition.flowtask_from_code.endswith(".consume_data") and transition.flowtask_to_code.endswith(".union_sensitivecheck") -%}
        {%- set consume_union.uuid = transition.propvalues_json.flowtransition_uuid -%}
    {%- endif -%}

    {%- if transition.flowtask_from_code.endswith(".union_sensitivecheck") and transition.flowtask_to_code.endswith(".protect_data") -%}
        {%- set union_protect.uuid = transition.propvalues_json.flowtransition_uuid -%}
    {%- endif -%}

    {%- if transition.flowtask_from_code.endswith(".protect_data") and transition.flowtask_to_code.endswith(".check_sensitiverule") -%}
        {%- set protect_filter.uuid = transition.propvalues_json.flowtransition_uuid -%}
    {%- endif -%}

    {%- if transition.flowtask_from_code.endswith(".check_sensitiverule") and transition.flowtask_to_code.endswith(".enrich_techcols_rdo") -%}
        {%- set filter_enrich_rdo.uuid = transition.propvalues_json.flowtransition_uuid -%}
    {%- endif -%}

    {%- if transition.flowtask_from_code.endswith(".check_sensitiverule") and transition.flowtask_to_code.endswith(".enrich_techcols_cdc") -%}
        {%- set filter_enrich_cdc.uuid = transition.propvalues_json.flowtransition_uuid -%}
    {%- endif -%}

    {%- if transition.flowtask_from_code.endswith(".check_sensitiverule") and transition.flowtask_to_code.endswith(".enrich_techcols_rdo") -%}
        {%- set filter_enrich_rdo.uuid = transition.propvalues_json.flowtransition_uuid -%}
    {%- endif -%}

    {%- if transition.flowtask_from_code.endswith(".enrich_techcols_cdc") and transition.flowtask_to_code.endswith(".load_target_cdc") -%}
        {%- set enrich_cdc_load.uuid = transition.propvalues_json.flowtransition_uuid -%}
    {%- endif -%}

    {%- if transition.flowtask_from_code.endswith(".enrich_techcols_rdo") and transition.flowtask_to_code.endswith(".load_target_rdo") -%}
        {%- set enrich_rdo_load.uuid = transition.propvalues_json.flowtransition_uuid -%}
    {%- endif -%}

{%- endfor -%}

{
    "diagrams": {
        "{{ diagram_id }}": {
            "diagramWithParameters": {
                "lifeCycleState": "ACTIVE",
                "versionId": "{{ diagram_id }}",
                "versionName": "latest",
                "versionType": "LATEST",
                "diagramId": "{{ diagram_id }}",
                "diagramNameEntity": {
                    "id": "{{ diagram_id }}",
                    "objectId": "{{ diagram_id }}",
                    "objectName": "{{ schema | upper }}_JOURNAL_{{ table | upper }}"
                },
                "createDt": "{{ (current_date.strftime('%Y-%m-%d %H:%M:%S.') + '%03d' % (current_date.microsecond // 1000)) }}",
                "changeDt": "{{ (current_date.strftime('%Y-%m-%d %H:%M:%S.') + '%03d' % (current_date.microsecond // 1000)) }}",
                "lastChangeByUser": "8f533ad1-0f64-46e5-b7fb-1f147bd67993",
                "createByUser": "8f533ad1-0f64-46e5-b7fb-1f147bd67993",
                "blockFlag": false,
                "errorResponseFlag": false,
                "treatTerminalStateAsInitial": false,
                "diagramDescription": "Journal diagram {{ table | upper }}, {{ schema | upper }} source.",
                "metaInfo": {
                    "nodeCounter": 9
                },
                "saveDiagramMessage": false,
                "diagramType": "DEFAULT",
                "notificationEmails": [],
                "inOutParameters": [],
                "diagramKeyFields": []
            },
            "nodes": [
                {
                    "nodeVersionId": "{{ enrich_cdc_node.flowtask_uuid }}",
                    "nodeId": "{{ enrich_cdc_node.flowtask_uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "nodeTypeId": 111,
                    "nodeName": "{{ table | lower }}_cdc_meta",
                    "nodeDescription": "Mapping and filling in the technical attributes of the CDC structure",
                    "jsonProperty": {
                        "nodeType": "111",
                        "script_text": "import java.time.LocalDateTime\nimport java.time.format.DateTimeFormatter\nimport java.time.temporal.ChronoUnit\n\njob_insert_id = (long) -1\njob_cdc_id = (long) __CONFIG__.get(\"job.instance_id\") \ntrx_id = null\ncsn_id = null\nbroker_partition_id = (long) BROKER_PARTITION\nbroker_offset_id = (long) BROKER_OFFSET_ID\ndeleted_flag = (actionType == 'DELETE') ? true : false\nsys_insert_stamp = LocalDateTime.now().plusHours(3)\nsrc_modified_stamp = LocalDateTime.parse(eqTimestamp, DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss.SSSSSS\"))\n\ndef actionTypeMap = [\n    \"ADD\": \"I\",\n    \"MODIFY\": \"U\",\n    \"DELETE\": \"D\",\n    \"ARCHIVE\": \"A\"\n]\nopertype_code = actionTypeMap[actionType]?: \"X\"",
                        "schema_id": "0cffa967-ceda-4436-a77a-4fe6d608e40f",
                        "schema_version_id": "0aeb91a7-95f0-1018-8195-f192c668031a",
                        "in": [
                            "BROKER_PARTITION",
                            "BROKER_OFFSET_ID",
                            "eqTimestamp",
                            "actionType"
                        ],
                        "out": [
                            "job_insert_id",
                            "job_cdc_id",
                            "trx_id",
                            "csn_id",
                            "broker_partition_id",
                            "broker_offset_id",
                            "deleted_flag",
                            "sys_insert_stamp",
                            "src_modified_stamp",
                            "opertype_code"
                        ],
                        "execution_options": {
                            "logging": true,
                            "start_new_chain": false
                        }
                    },
                    "jsonPropertyHashCode": -1157033136,
                    "validState": "VALID",
                    "metaInfo": {
                        "position": {
                            "x": 2709.8767815407978,
                            "y": 909.3526562129782
                        }
                    },
                    "isTemplate": false,
                    "displayType": "Groovy"
                },
                {
                    "nodeVersionId": "{{ protect_node.flowtask_uuid }}",
                    "nodeId": "{{ protect_node.flowtask_uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "nodeTypeId": 111,
                    "nodeName": "{{ table | lower }}_protection",
                    "nodeDescription": "The masking and hashing block for {{ table }} data",
                    "jsonProperty": {
                        "nodeType": "111",
                        "script_text": "import java.time.format.DateTimeFormatter;\nimport com.alfa.DataProtection;\nimport java.time.LocalDateTime;\nimport com.fasterxml.jackson.databind.ObjectMapper;\n\ndef (\nicebergDatabase, icebergTableName, metaDataBaseSdiName,\nsaltIcebergSdiName, sourceDatabaseName, sourceTableName\n) = [\n\"bdp__wallet\", \"md_hashrules\", \"UM\",\n\"iceberg_bdp\", \"{{ schema | lower }}\", \"{{ table | lower }}\"\n]\n\ndef properties = __PROPERTIES__\ndef s3Params = [\n\"bucketName\": \"nova\",\n\"maskingJarPath\": \"libs/masking/masking-functions-1.0-SNAPSHOT.jar\",\n]\n\n@Singleton(lazy = true)\nclass LocalDataProtector {\nDataProtection protector\nprivate static boolean isInitialized = false\nstatic LocalDataProtector initialize(\nicebergDatabase,icebergTableName,metaDataBaseSdiName,saltIcebergSdiName,\nproperties,sourceDatabaseName,sourceTableName,s3Params\n) {\nLocalDataProtector instance = LocalDataProtector.instance\nif (!isInitialized) {\ninstance.protector = new DataProtection.Builder()\n.setIcebergDatabase(icebergDatabase).setIcebergTableName(icebergTableName)\n.setMetaDataBaseSdiName(metaDataBaseSdiName).setS3Params(s3Params)\n.setProperties(properties).setSourceDatabaseName(sourceDatabaseName)\n.setSourceTableName(sourceTableName).setSaltIcebergSdiName(saltIcebergSdiName)\n.build()\nisInitialized = true\n}\nreturn instance\n}\n}\n\ndef protector = LocalDataProtector.initialize(\nicebergDatabase,icebergTableName,metaDataBaseSdiName,saltIcebergSdiName,\nproperties,sourceDatabaseName,sourceTableName,s3Params,\n).protector\n\nif (flag_key) {\n    def mapper = new ObjectMapper()\n    def meta = [:]\n    if (flag_value) {\n        meta = mapper.readValue(flag_value, Map)\n    } \n    protector.processFlag(flag_key, meta)\n}\n\n{%- for line in protect_node.script_lines %}{{ line }}{{ "\\n" if not loop.last }}{%- endfor %}",
                        "schema_id": "{{ mask_schema.id }}",
                        "schema_version_id": "{{ mask_schema.id }}",
                        "in": [
                            "flag_key",
                            "flag_value",
                        {%- for attr in protect_node.source_attributes %}
                            "{{ attr | upper }}"{{ "," if not loop.last }}
                        {%- endfor %}
                        ],
                        "out": [
                        {%- for attr in protect_node.target_attributes %}
                            "{{ attr | lower }}"{{ "," if not loop.last }}
                        {%- endfor %}
                        ],
                        "execution_options": {
                            "logging": true,
                            "start_new_chain": false
                        }
                    },
                    "jsonPropertyHashCode": 1016749863,
                    "validState": "VALID",
                    "metaInfo": {
                        "position": {
                            "x": 2110.5081976832003,
                            "y": 161.24217083415078
                        }
                    },
                    "isTemplate": false,
                    "displayType": "Groovy"
                },
                {
                    "nodeVersionId": "{{ check_sensitive_rule_node.flowtask_uuid }}",
                    "nodeId": "{{ check_sensitive_rule_node.flowtask_uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "nodeTypeId": 105,
                    "nodeName": "{{ table | lower }}_filter",
                    "nodeDescription": "Data filter to maintain change flags",
                    "jsonProperty": {
                        "nodeType": "105",
                        "filter": "flag_key IS NULL",
                        "execution_options": {
                            "logging": true,
                            "start_new_chain": false
                        }
                    },
                    "jsonPropertyHashCode": -554994373,
                    "validState": "VALID",
                    "metaInfo": {
                        "position": {
                            "x": 2110.1037714012527,
                            "y": 707.5945074497033
                        }
                    },
                    "isTemplate": false,
                    "displayType": "Filter"
                },
                {
                    "nodeVersionId": "{{ union_sensitivecheck_node.flowtask_uuid }}",
                    "nodeId": "{{ union_sensitivecheck_node.flowtask_uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "nodeTypeId": 130,
                    "nodeName": "{{ table | lower }}_union",
                    "nodeDescription": "union",
                    "jsonProperty": {
                        "nodeType": "130",
                        "execution_options": {
                            "logging": true
                        },
                        "complete_schemes_equality": false
                    },
                    "jsonPropertyHashCode": 79688,
                    "validState": "VALID",
                    "metaInfo": {
                        "position": {
                            "x": 1609.0,
                            "y": 161.0958682112
                        }
                    },
                    "isTemplate": false,
                    "displayType": "Union"
                },
                {
                    "nodeVersionId": "{{ enrich_rdo_node.flowtask_uuid }}",
                    "nodeId": "{{ enrich_rdo_node.flowtask_uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "nodeTypeId": 111,
                    "nodeName": "{{ table | lower }}_rdo_meta",
                    "nodeDescription": "Mapping and filling in the technical attributes of the RDO structure",
                    "jsonProperty": {
                        "nodeType": "111",
                        "script_text": "import java.time.LocalDateTime\nimport java.time.format.DateTimeFormatter\nimport java.time.temporal.ChronoUnit\n\njob_insert_id = (long) -1\njob_update_id = (long) -1\njob_cdc_id = (long) __CONFIG__.get(\"job.instance_id\") \ntrx_id = null\ncsn_id = null\nbroker_partition_id = (long) BROKER_PARTITION\nbroker_offset_id = (long) BROKER_OFFSET_ID\ndeleted_flag = (actionType == 'DELETE') ? true : false\nsys_insert_stamp = null\nsys_update_stamp = LocalDateTime.now().plusHours(3)\nsrc_modified_stamp = LocalDateTime.parse(eqTimestamp, DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss.SSSSSS\"))\n\ndef actionTypeMap = [\n    \"ADD\": \"I\",\n    \"MODIFY\": \"U\",\n    \"DELETE\": \"D\",\n    \"ARCHIVE\": \"A\"\n]\nopertype_last_code = actionTypeMap[actionType]?: \"X\"",
                        "schema_id": "e48c1f44-f6e6-46c1-a304-7b45e9265146",
                        "schema_version_id": "0aeb91a7-95f0-1018-8195-f1909ba0030f",
                        "in": [
                            "BROKER_PARTITION",
                            "BROKER_OFFSET_ID",
                            "eqTimestamp",
                            "actionType"
                        ],
                        "out": [
                            "job_insert_id",
                            "job_update_id",
                            "job_cdc_id",
                            "trx_id",
                            "csn_id",
                            "broker_partition_id",
                            "broker_offset_id",
                            "deleted_flag",
                            "sys_insert_stamp",
                            "sys_update_stamp",
                            "src_modified_stamp",
                            "opertype_last_code"
                        ],
                        "execution_options": {
                            "logging": true,
                            "start_new_chain": false
                        }
                    },
                    "jsonPropertyHashCode": 798338127,
                    "validState": "VALID",
                    "metaInfo": {
                        "position": {
                            "x": 2708.624697812045,
                            "y": 508.0596954887436
                        }
                    },
                    "isTemplate": false,
                    "displayType": "Groovy"
                },
                {
                    "nodeVersionId": "{{ consume_sensitive_node.flowtask_uuid }}",
                    "nodeId": "{{ consume_sensitive_node.flowtask_uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "nodeTypeId": 102,
                    "nodeName": "{{ table | lower }}_sensitive_flags",
                    "jsonProperty": {
                        "nodeType": "102",
                        "kafka_connection_uuid": "0ae951b0-95a4-125a-8195-b297b027017f",
                        "boundedness": "CONTINUOUS_UNBOUNDED",
                        "serde": {
                            "value": {
                                "format": "string",
                                "single_field_name": "flag_value"
                            },
                            "key": {
                                "name": "flag_key",
                                "enabled": true,
                                "format": "string"
                            },
                            "headers": {
                                "enabled": false
                            },
                            "partition": {
                                "enabled": false
                            },
                            "offset": {
                                "enabled": false
                            },
                            "timestamp": {
                                "enabled": false
                            }
                        },
                        "kafka": {
                            "consumer": {
                                "group_id": "{{ schema | lower }}_cids_{{ table | lower }}_consumer",
                                "start_offsets": {
                                    "committed": {
                                        "reset_strategy": "earliest"
                                    },
                                    "type": "committed"
                                },
                                "topic": "tracking_sensitive_flags",
                                "properties": []
                            }
                        },
                        "execution_options": {
                            "logging": true
                        }
                    },
                    "jsonPropertyHashCode": -841680894,
                    "validState": "VALID",
                    "metaInfo": {
                        "position": {
                            "x": 1006.0,
                            "y": 7.0
                        }
                    },
                    "isTemplate": false,
                    "displayType": "Kafka" 
                },
                {
                    "nodeVersionId": "{{ load_cdc_node.flowtask_uuid }}",
                    "nodeId": "{{ load_cdc_node.flowtask_uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "nodeTypeId": 121,
                    "nodeName": "{{ table | lower }}_cdc",
                    "jsonProperty": {
                        "nodeType": "121",
                        "data_provider_uuid": "0aeb93cc-95b8-1d5b-8195-cc7c38e50d50",
                        "table_name": "{{ schema | lower }}.{{ table | lower }}__cdc",
                        "field_mappings": [],
                        "additional_properties": [
                            {
                                "name": "upsert-enabled",
                                "value": "false",
                                "row_key": "263e877a-3518-400e-a169-3b13e9f606d8"
                            },
                            {
                                "name": "target-file-size-bytes",
                                "value": "268435456",
                                "row_key": "2c0c96fa-61c4-4d46-861c-a931c71922a1"
                            }
                        ],
                        "row_kind": {
                            "mapping": {
                                "enabled": false
                            }
                        },
                        "write_mode": "retract",
                        "deletes_mode": "key_fields"
                    },
                    "jsonPropertyHashCode": 587705356,
                    "validState": "VALID",
                    "metaInfo": {
                        "position": {
                            "x": 3213.3265069807976,
                            "y": 909.8627111249784
                        }
                    },
                    "isTemplate": false,
                    "displayType": "Iceberg"
                },
                {
                    "nodeVersionId": "{{ consume_node.flowtask_uuid }}",
                    "nodeId": "{{ consume_node.flowtask_uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "nodeTypeId": 102,
                    "nodeName": "{{ schema | upper }}_JOURNAL_{{ table | upper }}",
                    "jsonProperty": {
                        "nodeType": "102",
                        "kafka_connection_uuid": "0ae951b0-95a4-125a-8195-b297b027017f",
                        "schema_id": "{{ source_schema.id }}",
                        "schema_version_id": "{{ source_schema.id }}",
                        "boundedness": "CONTINUOUS_UNBOUNDED",
                        "serde": {
                            "value": {
                                "format": "json"
                            },
                            "key": {
                                "enabled": false
                            },
                            "headers": {
                                "enabled": false
                            },
                            "partition": {
                                "name": "BROKER_PARTITION",
                                "enabled": true
                            },
                            "offset": {
                                "name": "BROKER_OFFSET_ID",
                                "enabled": true
                            },
                            "timestamp": {
                                "enabled": false
                            }
                        },
                        "kafka": {
                            "consumer": {
                                "group_id": "{{ schema | lower }}_cids_{{ table | lower }}_consumer",
                                "start_offsets": {
                                    "committed": {
                                        "reset_strategy": "earliest"
                                    },
                                    "type": "committed"
                                },
                                "topic": "{{ schema | upper }}_JOURNAL_{{ table | upper }}",
                                "properties": []
                            }
                        },
                        "execution_options": {
                            "logging": true
                        }
                    },
                    "jsonPropertyHashCode": -807214317,
                    "validState": "VALID",
                    "metaInfo": {
                        "position": {
                            "x": 1009.0,
                            "y": 311.0
                        }
                    },
                    "isTemplate": false,
                    "displayType": "Kafka"
                },
                {
                    "nodeVersionId": "{{ load_rdo_node.flowtask_uuid }}",
                    "nodeId": "{{ load_rdo_node.flowtask_uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "nodeTypeId": 121,
                    "nodeName": "{{ table | lower }}_rdo",
                    "jsonProperty": {
                        "nodeType": "121",
                        "data_provider_uuid": "0aeb93cc-95b8-1d5b-8195-cc7c38e50d50",
                        "table_name": "{{ schema | lower }}.{{ table | lower }}",
                        "field_mappings": [],
                        "additional_properties": [
                            {
                                "name": "target-file-size-bytes",
                                "value": "268435456",
                                "row_key": "2c0c96fa-61c4-4d46-861c-a931c71922a1"
                            },
                            {
                                "name": "upsert-enabled",
                                "value": "true",
                                "row_key": "263e877a-3518-400e-a169-3b13e9f606d8"
                            }
                        ],
                        "write_mode": "upsert"
                    },
                    "jsonPropertyHashCode": 312684573,
                    "validState": "VALID",
                    "metaInfo": {
                        "position": {
                            "x": 3207.370461481443,
                            "y": 508.12214858858994
                        }
                    },
                    "isTemplate": false,
                    "displayType": "Iceberg"
                }
            ],
            "links": [
                {
                    "linkId": "{{ protect_filter.uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "prevNode": {
                        "nodeVersionId": "{{ protect_node.flowtask_uuid }}"
                    },
                    "prevNodeVersionId": "{{ protect_node.flowtask_uuid }}",
                    "nextNode": {
                        "nodeVersionId": "{{ check_sensitive_rule_node.flowtask_uuid }}"
                    },
                    "nextNodeVersionId": "{{ check_sensitive_rule_node.flowtask_uuid }}"
                },
                {
                    "linkId": "{{ sensitive_consume_union.uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "prevNode": {
                        "nodeVersionId": "{{ consume_sensitive_node.flowtask_uuid }}"
                    },
                    "prevNodeVersionId": "{{ consume_sensitive_node.flowtask_uuid }}",
                    "nextNode": {
                        "nodeVersionId": "{{ union_sensitivecheck_node.flowtask_uuid }}"
                    },
                    "nextNodeVersionId": "{{ union_sensitivecheck_node.flowtask_uuid }}"
                },
                {
                    "linkId": "{{ union_protect.uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "prevNode": {
                        "nodeVersionId": "{{ union_sensitivecheck_node.flowtask_uuid }}"
                    },
                    "prevNodeVersionId": "{{ union_sensitivecheck_node.flowtask_uuid }}",
                    "nextNode": {
                        "nodeVersionId": "{{ protect_node.flowtask_uuid }}"
                    },
                    "nextNodeVersionId": "{{ protect_node.flowtask_uuid }}"
                },
                {
                    "linkId": "{{ consume_union.uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "prevNode": {
                        "nodeVersionId": "{{ consume_node.flowtask_uuid }}"
                    },
                    "prevNodeVersionId": "{{ consume_node.flowtask_uuid }}",
                    "nextNode": {
                        "nodeVersionId": "{{ union_sensitivecheck_node.flowtask_uuid }}"
                    },
                    "nextNodeVersionId": "{{ union_sensitivecheck_node.flowtask_uuid }}"
                },
                {
                    "linkId": "{{ enrich_rdo_load.uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "prevNode": {
                        "nodeVersionId": "{{ enrich_rdo_node.flowtask_uuid }}"
                    },
                    "prevNodeVersionId": "{{ enrich_rdo_node.flowtask_uuid }}",
                    "nextNode": {
                        "nodeVersionId": "{{ load_rdo_node.flowtask_uuid }}"
                    },
                    "nextNodeVersionId": "{{ load_rdo_node.flowtask_uuid }}"
                },
                {
                    "linkId": "{{ filter_enrich_cdc.uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "prevNode": {
                        "nodeVersionId": "{{ check_sensitive_rule_node.flowtask_uuid }}"
                    },
                    "prevNodeVersionId": "{{ check_sensitive_rule_node.flowtask_uuid }}",
                    "nextNode": {
                        "nodeVersionId": "{{ enrich_cdc_node.flowtask_uuid }}"
                    },
                    "nextNodeVersionId": "{{ enrich_cdc_node.flowtask_uuid }}"
                },
                {
                    "linkId": "{{ enrich_cdc_load.uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "prevNode": {
                        "nodeVersionId": "{{ enrich_cdc_node.flowtask_uuid }}"
                    },
                    "prevNodeVersionId": "{{ enrich_cdc_node.flowtask_uuid }}",
                    "nextNode": {
                        "nodeVersionId": "{{ load_cdc_node.flowtask_uuid }}"
                    },
                    "nextNodeVersionId": "{{ load_cdc_node.flowtask_uuid }}"
                },
                {
                    "linkId": "{{ filter_enrich_rdo.uuid }}",
                    "diagramVersion": {
                        "versionId": "{{ diagram_id }}"
                    },
                    "diagramVersionId": "{{ diagram_id }}",
                    "prevNode": {
                        "nodeVersionId": "{{ check_sensitive_rule_node.flowtask_uuid }}"
                    },
                    "prevNodeVersionId": "{{ check_sensitive_rule_node.flowtask_uuid }}",
                    "nextNode": {
                        "nodeVersionId": "{{ enrich_rdo_node.flowtask_uuid }}"
                    },
                    "nextNodeVersionId": "{{ enrich_rdo_node.flowtask_uuid }}"
                }
            ],
            "variableLinkAssociations": [],
            "variableNodeAssociations": [],
            "changeDt": "{{ (current_date.strftime('%Y-%m-%d %H:%M:%S.') + '%03d' % (current_date.microsecond // 1000)) }}",
            "createDt": "{{ (current_date.strftime('%Y-%m-%d %H:%M:%S.') + '%03d' % (current_date.microsecond // 1000)) }}"
        }
    },
    "rootIdsAndDescriptions": {
        "{{ diagram_id }}": {
            "{{ diagram_id }}": "{{ schema | upper }}_JOURNAL_{{ table | upper }} (latest)"
        }
    }
}
{% endif %}